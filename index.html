<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Polo Fashions - Digital Bill</title>
    <link rel="shortcut icon" href="/icon.jpg" type="image/x-icon">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- HTML2Canvas for image generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 0;
            background: #f3f4f6;
        }
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .bill-preview {
            width: 100%;
        }
        .card-bill {
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border-radius: 12px;
            width: 600px;
            max-width: 100%;
            margin: 0 auto;
            overflow: hidden;
            padding: 32px;
            box-sizing: border-box;
        }
        .bill-border {
            border: 2px solid #1e3a8a;
            padding: 15px;
            border-radius: 8px;
            background: white;
        }
        .name-card {
            background: white;
        }
        .address-card {
            background: white;
        }
        .customer-suggestion {
            position: absolute;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .customer-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
        }
        .customer-item:hover {
            background: #dbeafe;
        }
        .database-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
            flex-shrink: 0;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ef4444;
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #22c55e;
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Typography */
        @media (max-width: 640px) {
            .card {
                padding: 12px;
            }
            .bill-border {
                padding: 15px;
            }
            h1 {
                font-size: 1.5rem !important;
            }
        }
        
        /* Desktop layout */
        @media (min-width: 1024px) {
            .app-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
                padding: 20px;
            }
            .card {
                padding: 30px;
            }
            .bill-preview {
                position: sticky;
                top: 20px;
                height: fit-content;
            }
            .card-bill {
                padding: 32px;
            }
            .database-container {
                max-width: 1200px;
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCJWXsmRLxi7a66IfR3xR57CvI2otZ1sdY",
            authDomain: "polo-fashions.firebaseapp.com",
            projectId: "polo-fashions",
            storageBucket: "polo-fashions.firebasestorage.app",
            messagingSenderId: "952281661533",
            appId: "1:952281661533:web:c685b9a2c3e350bc5f0db4",
            measurementId: "G-0Y2FPT4G7G"
        };

        // Cloudinary Configuration
        const CLOUDINARY_CLOUD_NAME = 'drzhtsyj8';
        const CLOUDINARY_UPLOAD_PRESET = 'polo_measurements';

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Cloudinary Upload Function
        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            formData.append('folder', 'polo-fashions');

            const response = await fetch(
                `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
                {
                    method: 'POST',
                    body: formData
                }
            );

            if (!response.ok) {
                throw new Error('Failed to upload image to Cloudinary');
            }

            const data = await response.json();
            return data.secure_url;
        }

        // Compress Image Function - HIGHER QUALITY for measurements
        function compressImage(file, maxWidth = 1200, quality = 0.9) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Only resize if image is too large
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
    </script>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Icon components
        const Download = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />
            </svg>
        );

        const Share2 = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="18" cy="5" r="3" /><circle cx="6" cy="12" r="3" /><circle cx="18" cy="19" r="3" />
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" /><line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
            </svg>
        );

        const MessageSquare = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
            </svg>
        );

        const Plus = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" />
            </svg>
        );

        const Trash2 = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                <line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" />
            </svg>
        );

        const Users = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
            </svg>
        );

        const Clock = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
            </svg>
        );

        const Home = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                <polyline points="9 22 9 12 15 12 15 22" />
            </svg>
        );

        const Search = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="11" cy="11" r="8" />
                <path d="m21 21-4.35-4.35" />
            </svg>
        );

        const ChevronDown = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="6 9 12 15 18 9" />
            </svg>
        );

        const ChevronUp = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="18 15 12 9 6 15" />
            </svg>
        );

        const Cloud = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" />
            </svg>
        );

        // Loading Overlay Component
        function LoadingOverlay({ message = 'Loading...' }) {
            return (
                <div className="loading-overlay">
                    <div className="text-center">
                        <div className="loader mx-auto mb-4"></div>
                        <div className="text-white text-xl font-bold">{message}</div>
                    </div>
                </div>
            );
        }

        // Customer Database Page
        function CustomerDatabase({ onBack, customers, orders, setOrders, loading }) {
            const [searchQuery, setSearchQuery] = useState('');
            const [expandedCustomer, setExpandedCustomer] = useState(null);
            const [viewingPhoto, setViewingPhoto] = useState(null);

            const filteredCustomers = customers.filter(customer => 
                customer.phone.includes(searchQuery) || 
                customer.name.toLowerCase().includes(searchQuery.toLowerCase())
            );

            const getCustomerOrders = (customerId) => {
                return orders.filter(o => o.customerId === customerId).sort((a, b) => 
                    new Date(b.createdAt) - new Date(a.createdAt)
                );
            };

            const toggleOrderStatus = async (orderId) => {
                try {
                    const order = orders.find(o => o.id === orderId);
                    await db.collection('orders').doc(orderId).update({
                        delivered: !order.delivered
                    });
                    
                    const updatedOrders = orders.map(o => {
                        if (o.id === orderId) {
                            return { ...o, delivered: !o.delivered };
                        }
                        return o;
                    });
                    setOrders(updatedOrders);
                } catch (error) {
                    console.error('Error updating order:', error);
                    alert('Failed to update order status');
                }
            };

            const deleteOrder = async (orderId, customerId) => {
                if (confirm('Are you sure you want to delete this order? This cannot be undone.')) {
                    try {
                        await db.collection('orders').doc(orderId).delete();
                        
                        const updatedOrders = orders.filter(order => order.id !== orderId);
                        setOrders(updatedOrders);
                        
                        const customerHasOrders = updatedOrders.some(o => o.customerId === customerId);
                        if (!customerHasOrders) {
                            await db.collection('customers').doc(customerId).delete();
                            window.location.reload();
                        }
                    } catch (error) {
                        console.error('Error deleting order:', error);
                        alert('Failed to delete order');
                    }
                }
            };

            const getTotalPending = () => {
                return orders.filter(o => !o.delivered).reduce((sum, o) => sum + o.balance, 0);
            };

            const getPendingCount = () => {
                return orders.filter(o => !o.delivered).length;
            };

            const getOverdueCount = () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                return orders.filter(o => !o.delivered && o.readyDate && new Date(o.readyDate) < today).length;
            };

            const isOrderOverdue = (order) => {
                if (!order.readyDate || order.delivered) return false;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                return new Date(order.readyDate) < today;
            };

            return (
                <div className="database-container">
                    {loading && <LoadingOverlay message="Loading data..." />}
                    
                    {viewingPhoto && (
                        <div 
                            className="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4"
                            onClick={() => setViewingPhoto(null)}
                        >
                            <button
                                onClick={() => setViewingPhoto(null)}
                                className="absolute top-4 right-4 bg-red-600 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl font-bold hover:bg-red-700 z-10"
                                style={{ fontSize: '24px' }}
                            >
                                ✕
                            </button>
                            <img
                                src={viewingPhoto}
                                alt="Measurement Full View"
                                className="max-w-full max-h-full object-contain"
                                onClick={(e) => e.stopPropagation()}
                            />
                        </div>
                    )}
                    
                    <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                        <div className="flex justify-between items-center mb-4">
                            <h1 className="text-4xl font-bold text-purple-900 flex items-center gap-3">
                                <Cloud size={40} />
                                Customer Database
                            </h1>
                            <button
                                onClick={onBack}
                                className="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-xl text-lg font-bold hover:bg-blue-700"
                            >
                                <Home size={24} />
                                Home
                            </button>
                        </div>

                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
                            <div className="bg-purple-50 p-4 rounded-lg border-2 border-purple-300">
                                <div className="text-sm text-purple-700 font-semibold">Total Customers</div>
                                <div className="text-3xl font-bold text-purple-900">{customers.length}</div>
                            </div>
                            <div className="bg-orange-50 p-4 rounded-lg border-2 border-orange-300">
                                <div className="text-sm text-orange-700 font-semibold">Pending Orders</div>
                                <div className="text-3xl font-bold text-orange-900">{getPendingCount()}</div>
                            </div>
                            <div className="bg-red-50 p-4 rounded-lg border-2 border-red-300">
                                <div className="text-sm text-red-700 font-semibold">⚠️ Overdue</div>
                                <div className="text-3xl font-bold text-red-900">{getOverdueCount()}</div>
                            </div>
                            <div className="bg-green-50 p-4 rounded-lg border-2 border-green-300">
                                <div className="text-sm text-green-700 font-semibold">Total Balance</div>
                                <div className="text-3xl font-bold text-green-900">₹{getTotalPending()}</div>
                            </div>
                        </div>

                        <div className="relative">
                            <Search className="absolute left-4 top-4 text-gray-400" size={24} />
                            <input
                                type="text"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                placeholder="Search by name or phone number..."
                                className="w-full pl-14 pr-4 py-4 text-lg border-2 border-purple-300 rounded-xl focus:border-purple-500 focus:outline-none"
                            />
                        </div>
                    </div>

                    <div className="space-y-4">
                        {filteredCustomers.length === 0 ? (
                            <div className="bg-white rounded-xl p-8 text-center text-gray-500">
                                {searchQuery ? 'No customers found matching your search.' : 'No customers yet. Create your first bill!'}
                            </div>
                        ) : (
                            filteredCustomers.map(customer => {
                                const customerOrders = getCustomerOrders(customer.id);
                                const isExpanded = expandedCustomer === customer.id;
                                const pendingOrders = customerOrders.filter(o => !o.delivered);
                                const overdueOrders = customerOrders.filter(o => isOrderOverdue(o));
                                const totalBalance = pendingOrders.reduce((sum, o) => sum + o.balance, 0);

                                return (
                                    <div key={customer.id} className="bg-white rounded-xl shadow-lg overflow-hidden border-2 border-purple-200">
                                        <div 
                                            className="p-6 cursor-pointer hover:bg-purple-50 transition-colors"
                                            onClick={() => setExpandedCustomer(isExpanded ? null : customer.id)}
                                        >
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-3 mb-2 flex-wrap">
                                                        <div className="text-2xl font-bold text-purple-900">{customer.name}</div>
                                                        {pendingOrders.length > 0 && (
                                                            <span className="bg-orange-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                                                                {pendingOrders.length} Pending
                                                            </span>
                                                        )}
                                                        {overdueOrders.length > 0 && (
                                                            <span className="bg-red-600 text-white px-3 py-1 rounded-full text-sm font-bold animate-pulse">
                                                                ⚠️ {overdueOrders.length} Overdue
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div className="text-lg text-gray-600 mb-2">📞 {customer.phone}</div>
                                                    <div className="flex gap-4 text-sm flex-wrap">
                                                        <span className="text-gray-600">Total Orders: <span className="font-bold text-gray-900">{customerOrders.length}</span></span>
                                                        {totalBalance > 0 && (
                                                            <span className="text-red-600">Balance Due: <span className="font-bold">₹{totalBalance}</span></span>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    {isExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
                                                </div>
                                            </div>
                                        </div>

                                        {isExpanded && customerOrders.length > 0 && (
                                            <div className="border-t-2 border-purple-200 bg-purple-50 p-6">
                                                <h3 className="text-xl font-bold text-purple-900 mb-4">Order History</h3>
                                                <div className="space-y-3">
                                                    {customerOrders.map(order => {
                                                        const orderIsOverdue = isOrderOverdue(order);
                                                        return (
                                                            <div key={order.id} className={`bg-white rounded-lg border-2 overflow-hidden ${orderIsOverdue ? 'border-red-500' : order.delivered ? 'border-green-300' : 'border-orange-300'}`}>
                                                                <div className="bg-blue-600 text-white px-3 py-2">
                                                                    <span className="text-lg font-bold">Card #{order.cardNumber}</span>
                                                                </div>
                                                                
                                                                <div className="p-3">
                                                                    <div className="flex items-start justify-between mb-2 pb-2 border-b border-gray-200">
                                                                        <div className="flex-1 text-xs">
                                                                            <div className="text-gray-600">📅 {order.date}</div>
                                                                            {order.readyDate && (
                                                                                <div className={`font-semibold ${orderIsOverdue ? 'text-red-600' : 'text-gray-600'}`}>
                                                                                    ⏰ {order.readyDate} {orderIsOverdue && '⚠️'}
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                        <button
                                                                            onClick={() => deleteOrder(order.id, order.customerId)}
                                                                            className="bg-red-500 hover:bg-red-600 text-white p-1.5 rounded ml-2"
                                                                            title="Delete"
                                                                        >
                                                                            <Trash2 size={14} />
                                                                        </button>
                                                                    </div>
                                                                    
                                                                    <div className="mb-2 pb-2 border-b border-gray-200 text-xs">
                                                                        <div className="flex justify-between mb-0.5">
                                                                            <span className="text-gray-600">Total:</span>
                                                                            <span className="font-semibold">₹{order.total}</span>
                                                                        </div>
                                                                        <div className="flex justify-between mb-0.5">
                                                                            <span className="text-gray-600">Advance:</span>
                                                                            <span className="font-semibold">₹{order.advance}</span>
                                                                        </div>
                                                                        <div className="flex justify-between pt-1 border-t border-gray-300">
                                                                            <span className="text-red-600 font-bold">Balance:</span>
                                                                            <span className="font-bold text-red-600">₹{order.balance}</span>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    <div className="mb-2 pb-2 border-b border-gray-200">
                                                                        <div className="text-xs font-semibold text-gray-700 mb-1">Items:</div>
                                                                        {order.items.map((item, idx) => (
                                                                            <div key={idx} className="text-xs text-gray-600">
                                                                                {item.shirts && `👔 ${item.shirts}`}
                                                                                {item.shirts && item.pants && ' • '}
                                                                                {item.pants && `👖 ${item.pants}`}
                                                                                {(item.shirts || item.pants) && ` - ₹${item.amount}`}
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                    
                                                                    <div className="flex items-center justify-between">
                                                                        <div className="flex items-center gap-2">
                                                                            <span className={`px-2 py-1 rounded text-xs font-bold ${order.delivered ? 'bg-green-100 text-green-700' : orderIsOverdue ? 'bg-red-100 text-red-700' : 'bg-orange-100 text-orange-700'}`}>
                                                                                {order.delivered ? '✓' : orderIsOverdue ? '⚠️' : '⏳'}
                                                                            </span>
                                                                            
                                                                            {order.measurementPhoto && (
                                                                                <img
                                                                                    src={order.measurementPhoto}
                                                                                    alt="📸"
                                                                                    className="w-8 h-8 object-cover rounded border border-blue-400 cursor-pointer hover:opacity-80"
                                                                                    onClick={() => setViewingPhoto(order.measurementPhoto)}
                                                                                />
                                                                            )}
                                                                        </div>
                                                                        
                                                                        <label className="toggle-switch">
                                                                            <input 
                                                                                type="checkbox" 
                                                                                checked={order.delivered || false}
                                                                                onChange={() => toggleOrderStatus(order.id)}
                                                                            />
                                                                            <span className="slider"></span>
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })
                        )}
                    </div>
                </div>
            );
        }

        // Home Page (Bill Creation)
        function HomePage({ onOpenDatabase, customers, setCustomers, orders, setOrders }) {
            const [cardNumber, setCardNumber] = useState('');
            const [customerName, setCustomerName] = useState('');
            const [phoneNumber, setPhoneNumber] = useState('');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [readyDate, setReadyDate] = useState('');
            const [items, setItems] = useState([{ shirts: '', pants: '', amount: '' }]);
            const [advance, setAdvance] = useState('');
            const [showCustomers, setShowCustomers] = useState(false);
            const [selectedCustomer, setSelectedCustomer] = useState(null);
            const [measurementPhoto, setMeasurementPhoto] = useState(null);
            const [measurementPhotoFile, setMeasurementPhotoFile] = useState(null);
            const [loading, setLoading] = useState(false);
            const billRef = useRef(null);
            const fileInputRef = useRef(null);

            const addItem = () => {
                setItems([...items, { shirts: '', pants: '', amount: '' }]);
            };

            const removeItem = (index) => {
                if (items.length > 1) {
                    setItems(items.filter((_, i) => i !== index));
                }
            };

            const updateItem = (index, field, value) => {
                const newItems = [...items];
                newItems[index][field] = value;
                setItems(newItems);
            };

            const calculateTotal = () => {
                return items.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            };

            const calculateBalance = () => {
                const total = calculateTotal();
                const adv = parseFloat(advance) || 0;
                return total - adv;
            };

            const searchCustomers = (phone) => {
                if (phone.length >= 3) {
                    return customers.filter(c => c.phone.includes(phone));
                }
                return [];
            };

            const selectCustomer = (customer) => {
                setPhoneNumber(customer.phone);
                setCustomerName(customer.name);
                setSelectedCustomer(customer);
                setShowCustomers(false);
            };

            const handlePhotoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setMeasurementPhotoFile(file);
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setMeasurementPhoto(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const removePhoto = () => {
                setMeasurementPhoto(null);
                setMeasurementPhotoFile(null);
                if (fileInputRef.current) {
                    fileInputRef.current.value = '';
                }
            };

            const saveOrder = async () => {
                try {
                    setLoading(true);
                    
                    // Upload photo to Cloudinary if exists - HIGH QUALITY
                    let photoUrl = null;
                    if (measurementPhotoFile) {
                        try {
                            // Compress less for better quality (1200px width, 90% quality)
                            const compressedBlob = await window.compressImage(measurementPhotoFile, 1200, 0.9);
                            photoUrl = await window.uploadToCloudinary(compressedBlob);
                        } catch (photoError) {
                            console.error('Photo upload error:', photoError);
                            // Continue without photo if upload fails
                            alert('Warning: Photo upload failed. Order will be saved without photo.');
                        }
                    }

                    // Find or create customer
                    let customer = customers.find(c => c.phone === phoneNumber);
                    
                    if (!customer) {
                        const customerRef = db.collection('customers').doc();
                        customer = {
                            id: customerRef.id,
                            name: customerName,
                            phone: phoneNumber,
                            createdAt: new Date().toISOString()
                        };
                        await customerRef.set(customer);
                        setCustomers([...customers, customer]);
                    } else {
                        if (customer.name !== customerName) {
                            await db.collection('customers').doc(customer.id).update({
                                name: customerName
                            });
                            const updatedCustomers = customers.map(c => 
                                c.phone === phoneNumber ? { ...c, name: customerName } : c
                            );
                            setCustomers(updatedCustomers);
                        }
                    }

                    // Create order
                    const orderRef = db.collection('orders').doc();
                    const order = {
                        id: orderRef.id,
                        cardNumber,
                        customerId: customer.id,
                        customerName: customerName,
                        customerPhone: customer.phone,
                        date,
                        readyDate,
                        items: [...items],
                        total: calculateTotal(),
                        advance: parseFloat(advance) || 0,
                        balance: calculateBalance(),
                        delivered: false,
                        measurementPhoto: photoUrl,
                        createdAt: new Date().toISOString()
                    };

                    await orderRef.set(order);
                    setOrders([...orders, order]);
                    
                    setLoading(false);
                    return order;
                } catch (error) {
                    setLoading(false);
                    console.error('Error saving order:', error);
                    
                    // Better error message
                    if (error.code === 'permission-denied') {
                        alert('❌ Firebase Permission Error!\n\nPlease update Firebase security rules:\n1. Go to Firebase Console\n2. Firestore Database → Rules\n3. Set: allow read, write: if true;\n4. Publish');
                    } else {
                        alert('Failed to save order: ' + error.message);
                    }
                    throw error;
                }
            };

            const downloadBill = async () => {
                const element = billRef.current;
                
                const originalWidth = element.style.width;
                element.style.width = '600px';
                
                const canvas = await html2canvas(element, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false,
                    width: 600,
                    windowWidth: 600
                });
                
                element.style.width = originalWidth;

                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `Bill_${cardNumber || 'new'}_${date}.png`;
                    link.click();
                    URL.revokeObjectURL(url);
                });
            };

            const shareBill = async () => {
                if (!phoneNumber || phoneNumber.length < 10) {
                    alert('10 ಅಂಕಿಯ ಫೋನ್ ಸಂಖ್ಯೆಯನ್ನು ನಮೂದಿಸಿ\nPlease enter customer phone number (10 digits)');
                    return;
                }

                try {
                    await saveOrder();
                    await downloadBill();

                    setTimeout(() => {
                        let formattedPhone = phoneNumber.replace(/\D/g, '');
                        if (formattedPhone.length === 10) {
                            formattedPhone = '91' + formattedPhone;
                        }

                        const readyDateText = readyDate ? `\nReady By: ${readyDate}` : '';
                        const message = `Hi ${customerName}! Your bill from Polo Fashions is ready.\n\nCard No: ${cardNumber}\nDate: ${date}${readyDateText}\nTotal: ₹${calculateTotal()}\nAdvance: ₹${advance || 0}\nBalance: ₹${calculateBalance()}\n\n🧾 Your digital Card is generated. Please check it once.\n\nThank you for choosing Polo Fashions!`;

                        const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                        window.location.href = whatsappUrl;
                    }, 1000);
                } catch (error) {
                    console.error('Error sharing bill:', error);
                }
            };

            const shareSMS = async () => {
                if (!phoneNumber || phoneNumber.length < 10) {
                    alert('10 ಅಂಕಿಯ ಫೋನ್ ಸಂಖ್ಯೆಯನ್ನು ನಮೂದಿಸಿ\nPlease enter customer phone number (10 digits)');
                    return;
                }

                try {
                    await saveOrder();

                    let formattedPhone = phoneNumber.replace(/\D/g, '');
                    if (formattedPhone.length === 10) {
                        formattedPhone = '+91' + formattedPhone;
                    }

                    const readyDateText = readyDate ? `\nReady By: ${readyDate}` : '';
                    const message = `Hi ${customerName}! Your bill from Polo Fashions is ready.\n\nCard No: ${cardNumber}\nDate: ${date}${readyDateText}\nTotal: Rs.${calculateTotal()}\nAdvance: Rs.${advance || 0}\nBalance: Rs.${calculateBalance()}\n\nYour digital Card is generated.\n\nPolo Fashions\nMob: 9742445626`;

                    const smsUrl = `sms:${formattedPhone}?body=${encodeURIComponent(message)}`;
                    window.location.href = smsUrl;
                } catch (error) {
                    console.error('Error sharing SMS:', error);
                }
            };

            const clearForm = () => {
                setCardNumber('');
                setCustomerName('');
                setPhoneNumber('');
                setDate(new Date().toISOString().split('T')[0]);
                setReadyDate('');
                setItems([{ shirts: '', pants: '', amount: '' }]);
                setAdvance('');
                setSelectedCustomer(null);
                setMeasurementPhoto(null);
                setMeasurementPhotoFile(null);
                if (fileInputRef.current) {
                    fileInputRef.current.value = '';
                }
            };

            const isOverdue = () => {
                if (!readyDate) return false;
                return new Date(readyDate) < new Date();
            };

            return (
                <div className="app-container">
                    {loading && <LoadingOverlay message="Saving to cloud..." />}
                    
                    <div className="card">
                        <div className="flex justify-between items-center mb-8">
                            <h1 className="text-2xl font-bold text-blue-900 flex items-center gap-2">
                                <Cloud size={28} />
                                👔 Polo Fashions
                            </h1>
                            <button
                                onClick={onOpenDatabase}
                                className="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-purple-700"
                            >
                                <Users size={20} />
                                Database
                            </button>
                        </div>

                        <div className="space-y-6 mb-8">
                            <div className="bg-blue-50 p-4 rounded-xl border-2 border-blue-500">
                                <label className="block text-lg font-bold mb-2 text-blue-900">
                                    📋 Card Number
                                </label>
                                <input
                                    type="text"
                                    value={cardNumber}
                                    onChange={(e) => setCardNumber(e.target.value)}
                                    className="w-full text-2xl font-bold p-3 border-2 border-blue-600 rounded-lg text-center"
                                    placeholder="123"
                                />
                            </div>

                            <div className="bg-orange-50 p-4 rounded-xl border-2 border-orange-500">
                                <label className="block text-lg font-bold mb-2 text-orange-900">
                                    👤 Customer Name
                                </label>
                                <input
                                    type="text"
                                    value={customerName}
                                    onChange={(e) => setCustomerName(e.target.value)}
                                    className="w-full text-xl font-bold p-3 border-2 border-orange-600 rounded-lg text-center"
                                    placeholder="Enter name"
                                />
                            </div>

                            <div className="bg-green-50 p-4 rounded-xl border-2 border-green-500 relative">
                                <label className="block text-lg font-bold mb-2 text-green-900">
                                    📞 Customer Phone Number
                                </label>
                                <input
                                    type="tel"
                                    value={phoneNumber}
                                    onChange={(e) => {
                                        setPhoneNumber(e.target.value);
                                        setShowCustomers(e.target.value.length >= 3);
                                    }}
                                    className="w-full text-2xl font-bold p-3 border-2 border-green-600 rounded-lg text-center"
                                    placeholder="9876543210"
                                    maxLength="10"
                                />
                                {showCustomers && searchCustomers(phoneNumber).length > 0 && (
                                    <div className="customer-suggestion mt-2">
                                        {searchCustomers(phoneNumber).map(customer => (
                                            <div
                                                key={customer.id}
                                                className="customer-item"
                                                onClick={() => selectCustomer(customer)}
                                            >
                                                <div className="font-bold">{customer.name}</div>
                                                <div className="text-sm text-gray-600">{customer.phone}</div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-base font-semibold mb-2">📅 Order Date</label>
                                    <input
                                        type="date"
                                        value={date}
                                        onChange={(e) => setDate(e.target.value)}
                                        className="w-full text-base p-2 border-2 border-gray-300 rounded-lg"
                                    />
                                </div>
                                <div className={`${isOverdue() ? 'bg-red-50 p-2 rounded-lg' : ''}`}>
                                    <label className="block text-base font-semibold mb-2 flex items-center gap-2">
                                        <Clock size={20} />
                                        Ready By {isOverdue() && <span className="text-red-600 font-bold text-sm">⚠️</span>}
                                    </label>
                                    <input
                                        type="date"
                                        value={readyDate}
                                        onChange={(e) => setReadyDate(e.target.value)}
                                        className={`w-full text-base p-2 border-2 rounded-lg ${isOverdue() ? 'border-red-500' : 'border-gray-300'}`}
                                    />
                                </div>
                            </div>

                            <div className="bg-yellow-50 p-4 rounded-xl border-2 border-yellow-500">
                                <label className="block text-lg font-bold mb-2 text-yellow-900">
                                    📸 Measurement Photo (High Quality - 25GB Cloudinary)
                                </label>
                                <input
                                    ref={fileInputRef}
                                    type="file"
                                    accept="image/*"
                                    capture="environment"
                                    onChange={handlePhotoUpload}
                                    className="hidden"
                                    id="photoUpload"
                                />
                                {!measurementPhoto ? (
                                    <label
                                        htmlFor="photoUpload"
                                        className="w-full bg-yellow-600 text-white py-3 px-4 rounded-lg text-base font-bold hover:bg-yellow-700 cursor-pointer flex items-center justify-center gap-2"
                                    >
                                        📷 Take/Upload Photo
                                    </label>
                                ) : (
                                    <div className="space-y-2">
                                        <img
                                            src={measurementPhoto}
                                            alt="Measurement"
                                            className="w-full h-48 object-cover rounded-lg border-2 border-yellow-600"
                                        />
                                        <button
                                            onClick={removePhoto}
                                            className="w-full bg-red-500 text-white py-2 px-4 rounded-lg text-sm font-bold hover:bg-red-600"
                                        >
                                            Remove Photo
                                        </button>
                                        <div className="text-xs text-center text-gray-600">
                                            ☁️ Will upload in HIGH QUALITY (1200px, 90% quality) to Cloudinary
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div>
                                <div className="flex justify-between items-center mb-3">
                                    <label className="text-base font-bold">🛍️ Items</label>
                                    <button
                                        onClick={addItem}
                                        className="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 flex items-center gap-2"
                                    >
                                        <Plus size={20} /> Add
                                    </button>
                                </div>

                                {items.map((item, index) => (
                                    <div key={index} className="grid grid-cols-4 gap-2 mb-2 bg-gray-50 p-3 rounded-lg">
                                        <input
                                            type="text"
                                            value={item.shirts}
                                            onChange={(e) => updateItem(index, 'shirts', e.target.value)}
                                            className="p-2 border-2 border-gray-300 rounded text-sm"
                                            placeholder="Shirts"
                                        />
                                        <input
                                            type="text"
                                            value={item.pants}
                                            onChange={(e) => updateItem(index, 'pants', e.target.value)}
                                            className="p-2 border-2 border-gray-300 rounded text-sm"
                                            placeholder="Pants"
                                        />
                                        <input
                                            type="number"
                                            value={item.amount}
                                            onChange={(e) => updateItem(index, 'amount', e.target.value)}
                                            className="p-2 border-2 border-gray-300 rounded text-sm font-bold"
                                            placeholder="₹"
                                        />
                                        <button
                                            onClick={() => removeItem(index)}
                                            className="p-2 bg-red-500 text-white rounded hover:bg-red-600 flex items-center justify-center"
                                            disabled={items.length === 1}
                                        >
                                            <Trash2 size={16} />
                                        </button>
                                    </div>
                                ))}
                            </div>

                            <div className="grid grid-cols-3 gap-2">
                                <div className="bg-gray-50 p-3 rounded-lg border-2 border-gray-300">
                                    <label className="block text-sm font-semibold mb-1">Total</label>
                                    <div className="text-xl font-bold text-gray-800">
                                        ₹{calculateTotal().toFixed(0)}
                                    </div>
                                </div>
                                <div className="bg-blue-50 p-3 rounded-lg border-2 border-blue-400">
                                    <label className="block text-sm font-semibold mb-1">Advance</label>
                                    <input
                                        type="number"
                                        value={advance}
                                        onChange={(e) => setAdvance(e.target.value)}
                                        className="w-full text-lg font-bold p-1 border-2 border-blue-500 rounded"
                                        placeholder="0"
                                    />
                                </div>
                                <div className="bg-red-50 p-3 rounded-lg border-2 border-red-400">
                                    <label className="block text-sm font-semibold mb-1">Balance</label>
                                    <div className="text-xl font-bold text-red-600">
                                        ₹{calculateBalance().toFixed(0)}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-3 mb-3">
                            <button
                                onClick={downloadBill}
                                className="flex flex-col items-center justify-center gap-1 bg-blue-600 text-white py-3 px-4 rounded-xl text-sm font-bold hover:bg-blue-700"
                            >
                                <Download size={24} />
                                <span>Download</span>
                            </button>
                            <button
                                onClick={clearForm}
                                className="flex flex-col items-center justify-center gap-1 bg-gray-600 text-white py-3 px-4 rounded-xl text-sm font-bold hover:bg-gray-700"
                            >
                                <Trash2 size={24} />
                                <span>Clear All</span>
                            </button>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <button
                                onClick={shareBill}
                                className="flex flex-col items-center justify-center gap-1 bg-green-600 text-white py-3 px-4 rounded-xl text-sm font-bold hover:bg-green-700"
                            >
                                <Share2 size={24} />
                                <span>WhatsApp</span>
                            </button>
                            <button
                                onClick={shareSMS}
                                className="flex flex-col items-center justify-center gap-1 bg-purple-600 text-white py-3 px-4 rounded-xl text-sm font-bold hover:bg-purple-700"
                            >
                                <MessageSquare size={24} />
                                <span>SMS</span>
                            </button>
                        </div>
                    </div>

                    <div className="bill-preview">
                        <h2 className="text-2xl font-bold text-center mb-6 text-gray-700">
                            👇 Bill Preview 👇
                        </h2>
                        <div ref={billRef} className="bg-white card-bill">
                            <div style={{fontSize: '12px'}} className="mb-2 text-center text-black">
                                ✋ We are not responsible for stitched cloths after 3 Months
                            </div>
                            
                            <div className="bill-border mb-3 name-card">
                                <div className="text-center">
                                    <div style={{fontSize: '32px'}} className="font-bold text-blue-900 mb-2">ಪೋಲೋ ಫ್ಯಾಷನ್ಸ್</div>
                                    <div style={{fontSize: '32px'}} className="font-bold my-3 text-blue-900">Card no: {cardNumber || '___'}</div>
                                    <div style={{fontSize: '22px'}} className="font-semibold mb-1">{customerName || 'Customer Name'}</div>
                                    <div style={{fontSize: '18px'}} className="mb-1">📞 {phoneNumber || '___________'}</div>
                                    <div style={{fontSize: '18px'}}>📅 Date: {date}</div>
                                    {readyDate && (
                                        <div style={{fontSize: '18px'}} className={`mt-2 font-bold ${isOverdue() ? 'text-red-600' : 'text-green-700'}`}>
                                            ⏰ Ready By: {readyDate}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="bill-border mb-3 overflow-hidden">
                                <table className="w-full">
                                    <thead className="bg-blue-900 text-white">
                                        <tr>
                                            <th style={{fontSize: '16px'}} className="p-2 text-left">Sr.</th>
                                            <th style={{fontSize: '16px'}} className="p-2 text-center">SHIRTS</th>
                                            <th style={{fontSize: '16px'}} className="p-2 text-center">PANTS</th>
                                            <th style={{fontSize: '16px'}} className="p-2 text-right">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {items.map((item, index) => (
                                            <tr key={index} className="border-b-2 border-blue-900">
                                                <td style={{fontSize: '16px'}} className="p-2">{index + 1}</td>
                                                <td style={{fontSize: '16px'}} className="p-2 text-center">{item.shirts}</td>
                                                <td style={{fontSize: '16px'}} className="p-2 text-center">{item.pants}</td>
                                                <td style={{fontSize: '16px'}} className="p-2 text-right font-semibold">
                                                    {item.amount}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            <div className="bill-border mb-3">
                                <div style={{fontSize: '20px'}} className="flex justify-between font-bold mb-2">
                                    <span>Total:</span>
                                    <span>₹{calculateTotal().toFixed(0)}</span>
                                </div>
                                <div style={{fontSize: '20px'}} className="flex justify-between font-bold mb-2">
                                    <span>Advance:</span>
                                    <span>₹{advance || '0'}</span>
                                </div>
                                <div style={{fontSize: '24px'}} className="flex justify-between font-bold text-red-600 pt-2 border-t-2 border-blue-900">
                                    <span>Balance:</span>
                                    <span>₹{calculateBalance().toFixed(0)}</span>
                                </div>
                            </div>

                            <div className="text-center bill-border address-card">
                                <div style={{fontSize: '32px'}} className="font-bold text-blue-900 mb-1">POLO FASHIONS</div>
                                <div style={{fontSize: '14px'}}>
                                    Get Your Dress Ready in as soon as 1–2 Hours – Only at Polo Fashions!
                                </div>
                                <div style={{fontSize: '14px'}}>#GF-30, Anjuman-Eslamiya Complex,</div>
                                <div style={{fontSize: '14px'}}>T.V.S. Road</div>
                                <div style={{fontSize: '14px'}}>Kollegal-571 440</div>
                                <div style={{fontSize: '16px'}} className="font-bold mt-1">Mob: 9742445626</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [currentPage, setCurrentPage] = useState('home');
            const [customers, setCustomers] = useState([]);
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const loadData = async () => {
                    try {
                        const customersSnapshot = await db.collection('customers').get();
                        const customersData = customersSnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setCustomers(customersData);

                        const ordersSnapshot = await db.collection('orders').orderBy('createdAt', 'desc').get();
                        const ordersData = ordersSnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setOrders(ordersData);

                        setLoading(false);
                    } catch (error) {
                        console.error('Error loading data:', error);
                        setLoading(false);
                        alert('Failed to load data from cloud. Please refresh the page.');
                    }
                };

                loadData();
            }, []);

            if (loading) {
                return <LoadingOverlay message="Loading from cloud..." />;
            }

            if (currentPage === 'database') {
                return (
                    <CustomerDatabase 
                        onBack={() => setCurrentPage('home')}
                        customers={customers}
                        orders={orders}
                        setOrders={setOrders}
                        loading={false}
                    />
                );
            }

            return (
                <HomePage 
                    onOpenDatabase={() => setCurrentPage('database')}
                    customers={customers}
                    setCustomers={setCustomers}
                    orders={orders}
                    setOrders={setOrders}
                />
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>